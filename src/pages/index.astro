---
import { getCollection, render } from "astro:content";
import Layout from "../layouts/Layout.astro";
import PostCard from "../components/PostCard.astro";
import Pagination from "../components/Pagination.astro";

const PAGE_SIZE = 10;

const posts = await getCollection("posts");
const articles = await getCollection("articles", ({ data }) => !data.draft);

const sortedPosts = posts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);
const sortedArticles = articles.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

// Get first page of posts
const firstPagePosts = sortedPosts.slice(0, PAGE_SIZE);
const hasMorePosts = sortedPosts.length > PAGE_SIZE;
const totalPages = Math.ceil(sortedPosts.length / PAGE_SIZE);

// Render post content
const renderedPosts = await Promise.all(
  firstPagePosts.map(async (post) => ({
    post,
    Content: (await render(post)).Content,
  }))
);
---

<Layout title="Blog">
  <h1 class="text-3xl font-bold mb-6">Blog</h1>

  <h2 class="text-xl font-semibold mt-8 mb-4">Articles</h2>
  {
    sortedArticles.length === 0 ? (
      <p>No articles yet.</p>
    ) : (
      <ul class="list-disc pl-5 space-y-2">
        {sortedArticles.map((article) => (
          <li>
            <a
              class="text-blue-600 hover:underline"
              href={`/articles/${article.id.replace(/\/index$/, "")}`}
            >
              {article.data.title}
            </a>
            <span class="text-gray-600">
              {" "}
              - {article.data.date.toLocaleString()}
            </span>
          </li>
        ))}
      </ul>
    )
  }

  <h2 class="text-xl font-semibold mt-8 mb-4">Posts</h2>
  {
    renderedPosts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <div class="space-y-8">
        {renderedPosts.map(({ post, Content }) => (
          <PostCard post={post} Content={Content} />
        ))}
      </div>
    )
  }

  {
    hasMorePosts && (
      <Pagination
        currentPage={1}
        totalPages={totalPages}
        nextUrl="/posts/2"
      />
    )
  }
</Layout>
