---
import { getCollection, render } from "astro:content";
import Layout from "../layouts/Layout.astro";
import PostCard from "../components/PostCard.astro";
import Pagination from "../components/Pagination.astro";
import { SITE } from "../site";
import { formatDateYMD } from "../utils/date";

const PAGE_SIZE = 10;

const posts = await getCollection("posts");

const sortedPosts = posts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

// Get first page of posts
const firstPagePosts = sortedPosts.slice(0, PAGE_SIZE);
const hasMorePosts = sortedPosts.length > PAGE_SIZE;
const totalPages = Math.ceil(sortedPosts.length / PAGE_SIZE);
const nextUrl = hasMorePosts ? "/posts/2/" : "";

// Render post content
const renderedPosts = await Promise.all(
  firstPagePosts.map(async (post) => ({
    post,
    Content: (await render(post)).Content,
  }))
);
---

<Layout title={SITE.name} description={SITE.description}>
  <h1 class="text-3xl font-bold mb-6">{SITE.name}</h1>

  {
    renderedPosts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <div class="space-y-10">
        {renderedPosts.map(({ post, Content }) => (
          <PostCard post={post} Content={Content} />
        ))}
      </div>
    )
  }

  {
    hasMorePosts && (
      <Pagination
        currentPage={1}
        totalPages={totalPages}
        nextUrl={nextUrl}
      />
    )
  }
</Layout>
